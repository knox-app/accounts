<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: Roboto, Arial, sans-serif; margin: 0; background-color: #f6f8fc; height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: white; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #e0e0e0; }
        .logo { font-size: 22px; color: #ea4335; font-weight: bold; display: flex; align-items: center; }
        .user-info { display: flex; align-items: center; }
        .user-pfp { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-left: 10px; border: 1px solid #ddd; }
        
        #app-content { flex: 1; overflow-y: auto; position: relative; padding: 10px; }

        /* INBOX ITEM */
        .email-item {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 5px;
            user-select: none;
        }
        .email-item:hover { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .sender-avatar { width: 40px; height: 40px; background: #e0e0e0; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; color: #555; }
        .email-details { flex: 1; overflow: hidden; }
        .sender { font-weight: bold; color: #202124; font-size: 15px; }
        .subject { font-weight: 500; color: #202124; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .snippet { color: #5f6368; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* COMPOSE */
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            background-color: white; color: #ea4335;
            width: 56px; height: 56px; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; cursor: pointer; z-index: 50;
        }
        .compose-container { background: white; height: 100%; border-radius: 8px; display: flex; flex-direction: column; }
        .compose-header { padding: 15px; background: #202124; color: white; display: flex; justify-content: space-between; border-radius: 8px 8px 0 0;}
        .compose-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        textarea.input-field { flex: 1; resize: none; }
        .send-btn { background: #1a73e8; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; align-self: flex-start; }

        /* READ VIEW */
        .read-view { background: white; padding: 20px; border-radius: 8px; min-height: 80%; }
        .read-header { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* CONTEXT MENU */
        #context-menu {
            display: none; position: fixed; background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000;
            width: 200px; border-radius: 5px;
        }
        .menu-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; }
        .menu-item:hover { background-color: #f5f5f5; }
        .menu-item i { margin-right: 10px; color: #555; }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; z-index: 999; }
    </style>
</head>
<body>

<header>
    <div class="logo"><i class="material-icons" style="margin-right: 8px;">mail</i> Mail App</div>
    <div class="user-info">
        <span id="user-name">Loading...</span>
        <img id="header-pfp" src="" class="user-pfp" alt="PFP">
        <button onclick="logout()" style="margin-left:10px; border:none; background:none; cursor:pointer; color:#1a73e8; font-size:12px;">Logout</button>
    </div>
</header>

<div id="app-content"></div>

<!-- Compose Button -->
<div id="fab-btn" class="fab" onclick="window.location.search='?1=compose=new'">+</div>

<!-- Long Press Context Menu -->
<div id="overlay" onclick="hideContextMenu()"></div>
<div id="context-menu">
    <div class="menu-item" onclick="deleteEmail()"><i class="material-icons">delete</i> Delete</div>
    <div class="menu-item" onclick="starEmail()"><i class="material-icons">star</i> Star / Unstar</div>
    <div class="menu-item" onclick="labelEmail()"><i class="material-icons">label</i> Create Label</div>
</div>

<!-- Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let selectedEmailId = null; 

    // 1. Check Auth
    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = "login.html";
        } else {
            currentUser = user;
            loadUserProfile();
            router();
        }
    });

    function loadUserProfile() {
        // Fetch user data from Firestore using email as ID
        db.collection('users').doc(currentUser.email).get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                document.getElementById('user-name').innerText = data.name;
                document.getElementById('header-pfp').src = data.pfp;
            }
        });
    }

    function logout() {
        auth.signOut().then(() => window.location.href = "login.html");
    }

    // 2. Router
    function router() {
        const url = window.location.search;
        const contentDiv = document.getElementById('app-content');
        const fab = document.getElementById('fab-btn');

        contentDiv.innerHTML = ''; // Clear page

        if (url.includes('1=compose=new')) {
            fab.style.display = 'none';
            renderCompose(contentDiv);
        } else if (url.includes('id=')) {
            // Read view logic
            fab.style.display = 'none';
            const params = new URLSearchParams(url);
            const mailId = params.get('id');
            renderRead(contentDiv, mailId);
        } else {
            // Default: Inbox
            fab.style.display = 'flex';
            renderInbox(contentDiv);
        }
    }

    // 3. Render Inbox
    function renderInbox(container) {
        container.innerHTML = '<h3 style="margin-left:10px; color:#555;">Inbox</h3><div id="email-list">Loading emails...</div>';
        
        // Query emails where 'to' equals current user's email
        db.collection('emails')
            .where('to', '==', currentUser.email)
            .orderBy('timestamp', 'desc')
            .onSnapshot(snapshot => {
                const list = document.getElementById('email-list');
                list.innerHTML = '';
                
                if (snapshot.empty) {
                    list.innerHTML = '<div style="text-align:center; margin-top:50px; color:#999;">No emails received yet.</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const el = document.createElement('div');
                    el.className = 'email-item';
                    
                    // Add Long Press Listener
                    addLongPressListener(el, doc.id);

                    // Click to read
                    el.onclick = () => {
                        if(el.dataset.isLongPress === "true") {
                            el.dataset.isLongPress = "false";
                            return;
                        }
                        window.location.search = `?1=read&id=${doc.id}`;
                    };

                    const starColor = data.isStarred ? '#f4b400' : '#ccc';
                    
                    el.innerHTML = `
                        <div class="sender-avatar">${data.from.charAt(0).toUpperCase()}</div>
                        <div class="email-details">
                            <div style="display:flex; justify-content:space-between;">
                                <span class="sender">${data.from}</span>
                                <i class="material-icons" style="font-size:16px; color:${starColor}">star</i>
                            </div>
                            <div class="subject">
                                ${data.label ? `<span style="background:#eee; padding:2px 5px; font-size:10px; border-radius:3px;">${data.label}</span>` : ''} 
                                ${data.subject}
                            </div>
                            <div class="snippet">${data.body}</div>
                        </div>
                    `;
                    list.appendChild(el);
                });
            });
    }

    // 4. Render Compose
    function renderCompose(container) {
        container.innerHTML = `
            <div class="compose-container">
                <div class="compose-header">
                    <span>New Message</span>
                    <i class="material-icons" onclick="window.history.back()" style="cursor:pointer;">close</i>
                </div>
                <div class="compose-body">
                    <label style="font-size:12px; color:#666;">From: ${currentUser.email}</label><br>
                    <input type="email" id="to-email" class="input-field" placeholder="To: (e.g. friend@app.com)">
                    <input type="text" id="subject" class="input-field" placeholder="Subject">
                    <textarea id="body" class="input-field" placeholder="Compose email..."></textarea>
                    <button class="send-btn" onclick="sendEmail()">Send</button>
                </div>
            </div>
        `;
    }

    // 5. Send Logic
    function sendEmail() {
        // IMPORTANT: Lowercase the recipient to match the database ID format
        const to = document.getElementById('to-email').value.toLowerCase().trim();
        const sub = document.getElementById('subject').value;
        const body = document.getElementById('body').value;

        if(!to || !sub || !body) return alert("Fill all fields");

        db.collection('emails').add({
            from: currentUser.email,
            to: to,
            subject: sub,
            body: body,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            isStarred: false,
            label: ""
        }).then(() => {
            alert("Sent!");
            window.location.search = "?1=inbox";
        }).catch(err => alert("Error: " + err.message));
    }

    // 6. Render Read
    function renderRead(container, id) {
        db.collection('emails').doc(id).get().then(doc => {
            if(!doc.exists) return container.innerHTML = "Email not found";
            const data = doc.data();
            
            container.innerHTML = `
                <div class="read-view">
                    <div class="read-header">
                        <button onclick="window.history.back()" style="border:none; bg:none; cursor:pointer;"><i class="material-icons">arrow_back</i></button>
                        <h2>${data.subject}</h2>
                        <p><strong>From:</strong> ${data.from}</p>
                        <p style="font-size:12px; color:#777;">To: Me</p>
                    </div>
                    <div style="line-height:1.6;">${data.body.replace(/\n/g, '<br>')}</div>
                </div>
            `;
        });
    }

    // 7. Long Press Logic
    let timer;
    function addLongPressListener(element, id) {
        const start = (e) => {
            selectedEmailId = id;
            timer = setTimeout(() => {
                element.dataset.isLongPress = "true";
                showContextMenu(e);
            }, 600);
        };
        const end = () => clearTimeout(timer);

        element.addEventListener('mousedown', start);
        element.addEventListener('touchstart', start);
        element.addEventListener('mouseup', end);
        element.addEventListener('touchend', end);
        element.addEventListener('mouseleave', end);
    }

    function showContextMenu(e) {
        const menu = document.getElementById('context-menu');
        const overlay = document.getElementById('overlay');
        
        let x = e.clientX || e.touches[0].clientX;
        let y = e.clientY || e.touches[0].clientY;

        menu.style.display = 'block';
        menu.style.top = y + 'px';
        menu.style.left = x + 'px';
        overlay.style.display = 'block';
        if(navigator.vibrate) navigator.vibrate(50);
    }

    function hideContextMenu() {
        document.getElementById('context-menu').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
    }

    function deleteEmail() {
        if(confirm("Delete this email?")) {
            db.collection('emails').doc(selectedEmailId).delete();
        }
        hideContextMenu();
    }

    function starEmail() {
        const ref = db.collection('emails').doc(selectedEmailId);
        ref.get().then(d => ref.update({ isStarred: !d.data().isStarred }));
        hideContextMenu();
    }

    function labelEmail() {
        const lbl = prompt("Enter Label Name:");
        if(lbl) db.collection('emails').doc(selectedEmailId).update({ label: lbl });
        hideContextMenu();
    }
</script>

</body>
</html>