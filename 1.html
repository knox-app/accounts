<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign in to X</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; height: 100vh; background: #fff; color: #0f1419; }
        .container { width: 100%; max-width: 600px; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .logo { margin-bottom: 20px; }
        h1 { font-size: 31px; font-weight: 700; margin-bottom: 30px; align-self: flex-start; }
        .input-group { width: 100%; margin-bottom: 20px; position: relative; }
        input { width: 100%; padding: 16px 10px; font-size: 17px; border: 1px solid #cfd9de; border-radius: 4px; box-sizing: border-box; outline: none; transition: 0.2s; }
        input:focus { border-color: #1d9bf0; ring: 1px #1d9bf0; }
        .btn { width: 100%; padding: 12px; border-radius: 25px; font-size: 15px; font-weight: 700; cursor: pointer; border: none; margin-bottom: 15px; }
        .btn-black { background-color: #0f1419; color: white; }
        .btn-white { background-color: white; border: 1px solid #cfd9de; color: #0f1419; }
        .btn:disabled { opacity: 0.5; }
        .action-link { margin-top: 10px; color: #1d9bf0; text-decoration: none; font-size: 14px; cursor: pointer; border: 1px solid #cfd9de; padding: 5px 15px; border-radius: 20px; display: inline-block; }
        .hidden { display: none; }
        .error { color: red; font-size: 13px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="logo">
        <svg viewBox="0 0 24 24" aria-hidden="true" width="30" height="30"><g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g></svg>
    </div>

    <!-- Step 1: Identifier -->
    <div id="step-1" style="width: 100%; max-width: 350px;">
        <h1>Sign in to X</h1>
        <div class="input-group">
            <input type="text" id="identifier" placeholder="Phone, email, or username">
            <div id="error-1" class="error"></div>
        </div>
        <button class="btn btn-black" onclick="handleIdentifier()">Next</button>
        <button class="btn btn-white" onclick="location.href='4.html'">Forgot email?</button>
        <p style="font-size:14px; color: #536471;">Don't have an account? <a href="2.html" style="color:#1d9bf0; text-decoration:none;">Sign up</a></p>
    </div>

    <!-- Step 1.5: Verify Email if Phone used -->
    <div id="step-verify-email" class="hidden" style="width: 100%; max-width: 350px;">
        <h1>Confirm your email</h1>
        <p style="color:#536471; font-size: 14px;">Please enter the email associated with this phone number.</p>
        <div class="input-group">
            <input type="email" id="confirm-email" placeholder="Email address">
            <div id="error-verify" class="error"></div>
        </div>
        <button class="btn btn-black" onclick="verifyEmailAssociation()">Next</button>
        <button class="btn btn-white" onclick="location.href='4.html'">Forgot email?</button>
    </div>

    <!-- Step 2: Password -->
    <div id="step-2" class="hidden" style="width: 100%; max-width: 350px;">
        <h1>Enter your password</h1>
        <div class="input-group">
            <input type="text" id="display-email" disabled style="background:#f7f9f9; border:none; color:#536471; margin-bottom:10px;">
            <input type="password" id="password" placeholder="Password">
            <div id="error-2" class="error"></div>
        </div>
        <button class="btn btn-black" onclick="handleLogin()">Log in</button>
        <button class="btn btn-white" onclick="forgotPassword()">Forgot password?</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
        authDomain: "xperts-metadata.firebaseapp.com",
        projectId: "xperts-metadata",
        storageBucket: "xperts-metadata.firebasestorage.app",
        messagingSenderId: "514845910910",
        appId: "1:514845910910:web:5a2402130a97b5d749b52f",
        measurementId: "G-CQ5KWGJSZB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    let currentUserEmail = "";
    let currentUserMobile = "";

    window.onload = function() {
        const type = urlParams.get('type');
        const emailParam = urlParams.get('email');
        
        // Auto Login Check
        const sessions = JSON.parse(localStorage.getItem('x_users_sessions') || '[]');
        if (sessions.length > 0 && type !== 'another-login' && !emailParam) {
            window.location.href = "https://abc.xyz";
            return;
        }

        // Case 4: Email in URL
        if (emailParam) {
            currentUserEmail = emailParam;
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.remove('hidden');
            document.getElementById('display-email').value = emailParam;
            
            // Check if logged in on device
            const isLogged = sessions.find(s => s.email === emailParam);
            if(isLogged) {
                document.getElementById('error-2').innerText = "Email Already Logged in This Device";
                document.getElementById('error-2').style.display = "block";
            }
        }
    };

    async function handleIdentifier() {
        const input = document.getElementById('identifier').value.trim();
        const errorDiv = document.getElementById('error-1');
        errorDiv.style.display = 'none';

        if (!input) return;

        // Check if input is email or phone (simple check)
        const isEmail = input.includes('@');
        
        try {
            let querySnapshot;
            if (isEmail) {
                querySnapshot = await db.collection('users').where('email', '==', input).get();
            } else {
                querySnapshot = await db.collection('users').where('mobile', '==', input).get();
            }

            if (querySnapshot.empty) {
                errorDiv.innerText = "Sorry, we could not find your account.";
                errorDiv.style.display = 'block';
                return;
            }

            const userData = querySnapshot.docs[0].data();
            
            if (isEmail) {
                // Case 1: Email Correct -> Password
                currentUserEmail = userData.email;
                showPasswordStep();
            } else {
                // Case 1: Phone Correct -> Ask Email
                currentUserMobile = userData.mobile;
                document.getElementById('step-1').classList.add('hidden');
                document.getElementById('step-verify-email').classList.remove('hidden');
            }
        } catch (e) {
            console.error(e);
            errorDiv.innerText = "An error occurred.";
            errorDiv.style.display = 'block';
        }
    }

    async function verifyEmailAssociation() {
        const inputEmail = document.getElementById('confirm-email').value.trim();
        const errorDiv = document.getElementById('error-verify');
        
        const querySnapshot = await db.collection('users')
            .where('mobile', '==', currentUserMobile)
            .where('email', '==', inputEmail)
            .get();

        if (!querySnapshot.empty) {
            currentUserEmail = inputEmail;
            showPasswordStep();
        } else {
            errorDiv.innerText = "Email does not match our records.";
            errorDiv.style.display = 'block';
        }
    }

    function showPasswordStep() {
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-verify-email').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        document.getElementById('display-email').value = currentUserEmail;
    }

    async function handleLogin() {
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('error-2');
        
        const docRef = db.collection('users').doc(currentUserEmail);
        const doc = await docRef.get();

        if (doc.exists) {
            if (doc.data().password === password) {
                // Success
                let sessions = JSON.parse(localStorage.getItem('x_users_sessions') || '[]');
                if (!sessions.find(s => s.email === currentUserEmail)) {
                    sessions.push({ email: currentUserEmail, data: doc.data() });
                    localStorage.setItem('x_users_sessions', JSON.stringify(sessions));
                }
                
                // URL Parameter logic check (Case 4 / Logic)
                const type = urlParams.get('type');
                if(type === 'another-login') {
                    // Just stay or go to switcher? Prompt implies not redirecting to main site yet
                    window.location.href = "3.html"; 
                } else {
                    window.location.href = "https://abc.xyz";
                }
            } else {
                errorDiv.innerText = "Wrong password.";
                errorDiv.style.display = 'block';
            }
        }
    }

    function forgotPassword() {
        window.location.href = `5.html?email=${currentUserEmail}`;
    }
</script>
</body>
</html>
