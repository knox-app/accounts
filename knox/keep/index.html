<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignite OS - AI Workspace</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #121212;
            --sidebar: #1e1e1e;
            --surface: #2c2c2c;
            --text: #e0e0e0;
            --text-mute: #a0a0a0;
            --accent: #bb86fc; /* AI Purple */
            --accent-sec: #03dac6; /* Teal */
            --border: #333;
            --danger: #cf6679;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* --- SIDEBAR (Collapsible) --- */
        .sidebar { 
            width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s ease;
            overflow: hidden; white-space: nowrap;
        }
        .sidebar.collapsed { width: 70px; }
        
        .brand-section { height: 60px; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border); }
        .menu-btn { background: none; border: none; color: var(--text); font-size: 20px; cursor: pointer; margin-right: 15px; }
        .brand-name { font-weight: bold; font-size: 18px; color: #fff; opacity: 1; transition: 0.2s; }
        .sidebar.collapsed .brand-name { opacity: 0; pointer-events: none; }

        .nav-item { display: flex; align-items: center; padding: 15px 22px; color: var(--text-mute); cursor: pointer; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(187, 134, 252, 0.1); color: var(--accent); border-left-color: var(--accent); }
        .nav-item i { width: 24px; font-size: 18px; margin-right: 15px; }

        /* --- MAIN AREA --- */
        .main { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        
        .top-bar { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; background: var(--bg); }
        .search-box { background: var(--surface); border-radius: 20px; padding: 8px 15px; width: 300px; display: flex; align-items: center; color: var(--text-mute); }
        .search-input { background: transparent; border: none; outline: none; color: #fff; margin-left: 10px; width: 100%; }

        .content-area { flex-grow: 1; padding: 30px; overflow-y: auto; }

        /* Notes Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .card { background: var(--surface); border-radius: 12px; padding: 20px; height: 180px; display: flex; flex-direction: column; cursor: pointer; position: relative; border: 1px solid transparent; transition: 0.2s; }
        .card:hover { border-color: var(--text-mute); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card-title { font-weight: bold; margin-bottom: 10px; color: #fff; }
        .card-body { font-size: 14px; color: var(--text-mute); overflow: hidden; flex-grow: 1; display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; }

        /* Create Button (Floating) */
        .fab { position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(187, 134, 252, 0.4); transition: 0.2s; }
        .fab:hover { transform: scale(1.1); }

        /* --- EDITOR MODAL (The Workspace) --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; backdrop-filter: blur(5px); }
        .modal-content { position: absolute; top: 0; right: 0; width: 100%; height: 100%; display: flex; }
        
        /* Editor Left: Writing */
        .editor-main { flex-grow: 1; background: var(--bg); display: flex; flex-direction: column; padding: 40px; max-width: 70%; margin: 0 auto; border-right: 1px solid var(--border); }
        .editor-toolbar { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .editor-title { background: transparent; border: none; font-size: 32px; font-weight: bold; color: #fff; outline: none; margin-bottom: 20px; }
        .editor-area { background: transparent; border: none; font-size: 18px; line-height: 1.6; color: var(--text); outline: none; resize: none; flex-grow: 1; font-family: inherit; }

        /* Editor Right: AI Tools */
        .ai-sidebar { width: 350px; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .ai-header { font-weight: bold; color: var(--accent); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        /* AI Chat Box */
        .ai-chat { flex-grow: 1; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; overflow-y: auto; margin-bottom: 15px; font-size: 13px; }
        .ai-msg { margin-bottom: 10px; padding: 8px; border-radius: 8px; }
        .ai-msg.bot { background: rgba(187, 134, 252, 0.1); border-left: 3px solid var(--accent); }
        
        .ai-controls { display: flex; flex-direction: column; gap: 10px; }
        .ai-btn { background: var(--accent); color: #000; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .ai-input { background: #121212; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; outline: none; }
        
        /* Translator Controls */
        .trans-box { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border); }
        .trans-select { width: 100%; background: #121212; color: #fff; padding: 8px; border: 1px solid var(--border); margin-bottom: 10px; border-radius: 4px; }

        /* --- Share Modal --- */
        .share-overlay { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--surface); padding: 20px; border-radius: 8px; border: 1px solid var(--border); z-index: 200; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }

        .hidden { display: none; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="brand-section">
            <button class="menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
            <span class="brand-name">Ignite OS</span>
        </div>
        
        <div class="nav-item active" onclick="loadView('notes')">
            <i class="fa-regular fa-file-lines"></i> <span class="brand-name">My Notes</span>
        </div>
        <div class="nav-item" onclick="loadView('shared')">
            <i class="fa-solid fa-users-viewfinder"></i> <span class="brand-name">Shared</span>
        </div>
        <div class="nav-item" onclick="loadView('trash')">
            <i class="fa-regular fa-trash-can"></i> <span class="brand-name">Trash</span>
        </div>

        <div style="margin-top:auto; border-top:1px solid #333; padding-top:10px;">
             <div class="nav-item" onclick="logout()">
                <i class="fa-solid fa-right-from-bracket" style="color:var(--danger)"></i> <span class="brand-name">Logout</span>
            </div>
        </div>
    </div>

    <!-- MAIN -->
    <div class="main">
        <div class="top-bar">
            <div style="font-weight:bold; color:var(--accent);">Workspace</div>
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input class="search-input" id="searchInp" placeholder="Search notes..." onkeyup="renderGrid()">
            </div>
            <div id="userId" style="font-size:12px; color:gray;"></div>
        </div>

        <div class="content-area">
            <div class="grid" id="grid"></div>
        </div>

        <!-- Floating Create Button -->
        <div class="fab" onclick="createNewNote()">
            <i class="fa-solid fa-plus"></i>
        </div>
    </div>

    <!-- FULL SCREEN EDITOR WITH AI SIDEBAR -->
    <div class="modal" id="editorModal">
        <div class="modal-content">
            
            <!-- Writing Area -->
            <div class="editor-main">
                <div class="editor-toolbar">
                    <button onclick="closeEditor()" style="background:none; border:none; color:gray; font-size:20px; cursor:pointer;"><i class="fa-solid fa-arrow-left"></i> Back</button>
                    <div style="display:flex; gap:10px;">
                        <span id="saveStatus" style="font-size:12px; color:gray; margin-right:10px; display:flex; align-items:center;">Saved</span>
                        <button onclick="openShare()" style="background:var(--accent-sec); border:none; padding:5px 15px; border-radius:4px; font-weight:bold; cursor:pointer;">Share</button>
                    </div>
                </div>
                <input id="editTitle" class="editor-title" placeholder="Untitled Note">
                <textarea id="editContent" class="editor-area" placeholder="Start typing..."></textarea>
            </div>

            <!-- AI Sidebar -->
            <div class="ai-sidebar">
                <div class="ai-header"><i class="fa-solid fa-robot"></i> Ignite AI</div>
                
                <!-- 1. Wikipedia Gen AI -->
                <div class="ai-chat" id="aiChat">
                    <div class="ai-msg bot">Hi! I am the Ignite Knowledge Engine. Ask me anything to generate content.</div>
                </div>
                <div class="ai-controls">
                    <input id="wikiQuery" class="ai-input" placeholder="e.g. History of Rome...">
                    <button class="ai-btn" onclick="askIgniteAI()">Generate Answer</button>
                    <button class="ai-btn" style="background:var(--surface); border:1px solid var(--border); color:#fff;" onclick="insertToNote()">Insert Last Answer</button>
                </div>

                <!-- 2. Real-Time Translator -->
                <div class="trans-box">
                    <div class="ai-header" style="color:var(--accent-sec); font-size:14px;"><i class="fa-solid fa-language"></i> Live Translate</div>
                    <p style="font-size:12px; color:gray; margin-bottom:5px;">Translate current note to:</p>
                    <select id="langSelect" class="trans-select">
                        <option value="hi">Hindi (हिंदी)</option>
                        <option value="es">Spanish (Español)</option>
                        <option value="fr">French (Français)</option>
                        <option value="de">German (Deutsch)</option>
                        <option value="ja">Japanese (日本語)</option>
                    </select>
                    <button class="ai-btn" style="background:var(--accent-sec);" onclick="translateNote()">Translate Now</button>
                    <div style="margin-top:5px; font-size:11px; color:gray;">* Changes content for all viewers</div>
                </div>
            </div>

        </div>
    </div>

    <!-- SHARE POPUP -->
    <div class="share-overlay" id="shareOverlay">
        <h3 style="margin-top:0;">Add Contributor</h3>
        <input id="shareEmail" class="ai-input" style="width:100%; box-sizing:border-box; margin-bottom:10px;" placeholder="ID (user@ignite.com)">
        <select id="shareRole" class="trans-select">
            <option value="editor">Editor (Can Edit)</option>
            <option value="viewer">Viewer (Read Only)</option>
        </select>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
            <button onclick="document.getElementById('shareOverlay').style.display='none'" style="background:none; border:none; color:#fff; cursor:pointer;">Cancel</button>
            <button onclick="performShare()" class="ai-btn">Add</button>
        </div>
    </div>

    <script>
        // --- FIREBASE ---
        const firebaseConfig = { apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw", authDomain: "xperts-metadata.firebaseapp.com", projectId: "xperts-metadata", storageBucket: "xperts-metadata.firebasestorage.app", messagingSenderId: "514845910910", appId: "1:514845910910:web:5a2402130a97b5d749b52f", measurementId: "G-CQ5KWGJSZB" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- SESSION ---
        let user = null;
        let currentView = 'notes';
        let notesData = [];

        function init() {
            const s = localStorage.getItem('xperts_multi_session');
            if(!s) { window.location.href="index.html"; return; }
            user = JSON.parse(s)[0];
            document.getElementById('userId').innerText = user.igniteId || user.name;
            loadView('notes');
        }
        function logout() { localStorage.removeItem('xperts_multi_session'); window.location.href="index.html"; }

        // --- UI LOGIC ---
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        // --- DATA LOGIC ---
        let unsub = null;
        function loadView(view) {
            currentView = view;
            // Update active sidebar
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            // (Simple active state logic omitted for brevity, assumes clicks work)
            
            const grid = document.getElementById('grid');
            grid.innerHTML = '<div style="color:gray">Loading...</div>';
            
            if(unsub) unsub();

            let q;
            if(view === 'notes') q = db.collection('notes').where('ownerId','==',user.uid).where('trash','==',false);
            else if(view === 'trash') q = db.collection('notes').where('ownerId','==',user.uid).where('trash','==',true);
            else if(view === 'shared') q = db.collection('notes').where('sharedWith','array-contains',user.igniteId);

            unsub = q.onSnapshot(snap => {
                notesData = [];
                snap.forEach(d => notesData.push({id:d.id, ...d.data()}));
                // Sort by date desc
                notesData.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                renderGrid();
            });
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            const search = document.getElementById('searchInp').value.toLowerCase();
            
            const filtered = notesData.filter(n => (n.title||'').toLowerCase().includes(search) || (n.content||'').toLowerCase().includes(search));
            
            filtered.forEach(n => {
                const el = document.createElement('div');
                el.className = 'card';
                el.onclick = () => openEditor(n.id);
                el.innerHTML = `
                    <div class="card-title">${n.title || 'Untitled'}</div>
                    <div class="card-body">${n.content || 'No content'}</div>
                    ${currentView === 'notes' ? `<div style="position:absolute; bottom:15px; right:15px; font-size:12px; color:gray;" onclick="trashNote('${n.id}', event)"><i class="fa-solid fa-trash"></i></div>` : ''}
                `;
                grid.appendChild(el);
            });
        }

        async function createNewNote() {
            const doc = await db.collection('notes').add({
                title: '', content: '', ownerId: user.uid, trash: false, sharedWith: [], 
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            openEditor(doc.id);
        }

        async function trashNote(id, e) {
            e.stopPropagation();
            if(confirm('Move to Trash?')) await db.collection('notes').doc(id).update({trash:true});
        }

        // --- EDITOR & AI LOGIC ---
        let currentNoteId = null;
        let editUnsub = null;
        let lastAiResponse = "";

        async function openEditor(id) {
            currentNoteId = id;
            document.getElementById('editorModal').style.display = 'block';
            
            editUnsub = db.collection('notes').doc(id).onSnapshot(doc => {
                const d = doc.data();
                if(document.activeElement.id !== 'editTitle') document.getElementById('editTitle').value = d.title;
                if(document.activeElement.id !== 'editContent') document.getElementById('editContent').value = d.content;
            });
        }

        function closeEditor() {
            document.getElementById('editorModal').style.display = 'none';
            if(editUnsub) editUnsub();
            currentNoteId = null;
        }

        // Auto Save
        const saveHandler = () => {
            document.getElementById('saveStatus').innerText = 'Saving...';
            setTimeout(() => {
                if(currentNoteId) {
                    db.collection('notes').doc(currentNoteId).update({
                        title: document.getElementById('editTitle').value,
                        content: document.getElementById('editContent').value
                    }).then(() => document.getElementById('saveStatus').innerText = 'Saved');
                }
            }, 800);
        };
        document.getElementById('editTitle').addEventListener('input', saveHandler);
        document.getElementById('editContent').addEventListener('input', saveHandler);

        // --- 1. IGNITE AI (WIKIPEDIA ENGINE) ---
        async function askIgniteAI() {
            const query = document.getElementById('wikiQuery').value;
            if(!query) return;

            const chat = document.getElementById('aiChat');
            chat.innerHTML += `<div class="ai-msg" style="background:#333;">You: ${query}</div>`;
            chat.scrollTop = chat.scrollHeight;

            // Fetch Wikipedia Summary
            try {
                const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
                const data = await res.json();

                if(data.extract) {
                    lastAiResponse = data.extract;
                    chat.innerHTML += `<div class="ai-msg bot"><b>AI:</b> ${data.extract}</div>`;
                } else {
                    chat.innerHTML += `<div class="ai-msg bot">I couldn't find information on that. Try a different term.</div>`;
                }
            } catch(e) {
                chat.innerHTML += `<div class="ai-msg bot">Error connecting to Knowledge Engine.</div>`;
            }
            chat.scrollTop = chat.scrollHeight;
            document.getElementById('wikiQuery').value = '';
        }

        function insertToNote() {
            if(lastAiResponse) {
                const area = document.getElementById('editContent');
                area.value += "\n\n" + lastAiResponse;
                saveHandler(); // Trigger save
            }
        }

        // --- 2. LIVE TRANSLATOR (Samsung Style) ---
        async function translateNote() {
            const content = document.getElementById('editContent').value;
            const targetLang = document.getElementById('langSelect').value;
            if(!content) return;

            document.getElementById('saveStatus').innerText = "Translating...";

            // Use MyMemory API (Free, limited usage)
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(content)}&langpair=en|${targetLang}`);
                const data = await res.json();
                
                if(data.responseData.translatedText) {
                    // Replace content (Real-time sync to other users)
                    document.getElementById('editContent').value = data.responseData.translatedText;
                    saveHandler(); // Save immediately
                    alert("Translated successfully!");
                }
            } catch(e) {
                alert("Translation limit reached or error.");
            }
        }

        // --- SHARING ---
        function openShare() { document.getElementById('shareOverlay').style.display = 'block'; }
        
        async function performShare() {
            const email = document.getElementById('shareEmail').value;
            // Admin can assign roles logic here (simplified to array for now)
            if(email.includes('@ignite.com')) {
                await db.collection('notes').doc(currentNoteId).update({
                    sharedWith: firebase.firestore.FieldValue.arrayUnion(email)
                });
                alert('Added contributor');
                document.getElementById('shareOverlay').style.display = 'none';
            } else { alert('Invalid ID'); }
        }

        init();
    </script>
</body>
</html>