<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignite Workspace - Pro</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Icons (FontAwesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #202124;
            --surface: #2d2e30;
            --surface-hover: #35363a;
            --text: #e8eaed;
            --text-secondary: #9aa0a6;
            --accent: #fbbc04;
            --danger: #f28b82;
            --border: #5f6368;
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
            --modal-backdrop: rgba(0,0,0,0.7);
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        
        /* --- HEADER --- */
        nav { display: flex; justify-content: space-between; align-items: center; padding: 12px 24px; border-bottom: 1px solid var(--border); background: var(--bg); position: sticky; top: 0; z-index: 50; }
        .brand { font-size: 22px; font-weight: 600; display: flex; align-items: center; gap: 10px; color: #fff; }
        .brand i { color: var(--accent); }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-chip { background: var(--surface); padding: 6px 15px; border-radius: 20px; font-size: 13px; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-logout { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 6px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .btn-logout:hover { background: var(--danger); color: #000; }

        /* --- CREATE AREA --- */
        .create-container { display: flex; justify-content: center; margin: 30px 0; padding: 0 10px; }
        .create-card { background: var(--surface); width: 600px; max-width: 100%; border-radius: 8px; box-shadow: var(--shadow); border: 1px solid transparent; overflow: hidden; transition: 0.3s; position: relative; }
        .create-card.active { border-color: var(--border); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        
        .inp-title { width: 100%; background: transparent; border: none; padding: 15px 15px 5px 15px; color: #fff; font-weight: bold; font-size: 16px; outline: none; display: none; box-sizing: border-box; }
        .inp-content { width: 100%; background: transparent; border: none; padding: 12px 15px; color: var(--text); font-size: 14px; outline: none; resize: none; font-family: inherit; box-sizing: border-box; }
        
        .create-actions { display: none; justify-content: flex-end; padding: 5px 15px 10px 15px; gap: 10px; }
        .btn-text { background: transparent; border: none; color: var(--text); font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 4px; }
        .btn-text:hover { background: rgba(255,255,255,0.05); }

        /* --- GRID LAYOUT --- */
        .notes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; padding: 20px 40px; }
        
        .note-card { 
            background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; 
            display: flex; flex-direction: column; justify-content: space-between; min-height: 120px;
            cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative;
        }
        .note-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); border-color: #999; }
        
        .note-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .note-title { font-weight: 600; font-size: 16px; color: #fff; }
        .note-body { font-size: 14px; color: var(--text-secondary); line-height: 1.5; white-space: pre-wrap; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 6; -webkit-box-orient: vertical; flex-grow: 1;}

        /* --- CARD TOOLBAR --- */
        .card-toolbar { 
            margin-top: 15px; display: flex; justify-content: flex-end; gap: 5px; 
            opacity: 0; transition: 0.2s; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;
        }
        .note-card:hover .card-toolbar { opacity: 1; }
        
        .tool-btn { background: transparent; border: none; color: var(--text-secondary); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .tool-btn:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .tool-btn.delete:hover { background: rgba(242, 139, 130, 0.2); color: var(--danger); }
        
        .shared-badge { font-size: 10px; background: #444; padding: 2px 6px; border-radius: 4px; color: var(--accent); margin-left: 5px; }

        /* --- EDITOR MODAL --- */
        .modal { display: none; position: fixed; inset: 0; background: var(--modal-backdrop); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { 
            background: var(--surface); width: 800px; height: 80vh; border-radius: 12px; 
            display: flex; flex-direction: column; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.8); border: 1px solid var(--border);
        }
        
        /* Modal Header */
        .editor-header { padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .editor-status { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .saving-spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid var(--text-secondary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Collaborators */
        .avatars { display: flex; flex-direction: row-reverse; margin-left: 20px; }
        .avatar { 
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--surface); 
            display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: #fff;
            margin-left: -10px; position: relative; cursor: default;
        }
        .avatar:hover { z-index: 10; transform: scale(1.1); }
        .avatar::after {
            content: attr(title); position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            background: #000; padding: 3px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; opacity: 0; pointer-events: none;
        }
        .avatar:hover::after { opacity: 1; }

        /* Editor Body */
        .editor-body { flex-grow: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }
        .editor-title { background: transparent; border: none; color: #fff; font-size: 24px; font-weight: bold; width: 100%; margin-bottom: 15px; outline: none; }
        .editor-text { background: transparent; border: none; color: var(--text); font-size: 16px; line-height: 1.6; width: 100%; flex-grow: 1; resize: none; outline: none; font-family: inherit; }

        .modal-close { position: absolute; top: 15px; left: 15px; background: transparent; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; }

        /* Share Popup */
        .share-overlay { display: none; position: absolute; top: 60px; right: 20px; width: 300px; background: #3c4043; border-radius: 8px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 2000; border: 1px solid var(--border); }
        .share-inp-group { display: flex; gap: 5px; margin-top: 10px; }
        .share-inp { flex: 1; background: #202124; border: 1px solid var(--border); color: #fff; padding: 8px; border-radius: 4px; outline: none; }
        .btn-share { background: var(--accent); border: none; color: #000; font-weight: bold; padding: 0 12px; border-radius: 4px; cursor: pointer; }

        /* Typing Flag */
        .typing-badge { 
            position: absolute; bottom: 20px; left: 25px; background: var(--accent); color: #000; 
            padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; 
            opacity: 0; transition: opacity 0.3s; pointer-events: none;
        }

    </style>
</head>
<body>

    <!-- NAVBAR -->
    <nav>
        <div class="brand">
            <i class="fa-solid fa-fire"></i> Ignite Workspace
        </div>
        <div class="user-menu">
            <div class="user-chip"><i class="fa-solid fa-user-astronaut"></i> <span id="displayId">Loading...</span></div>
            <button class="btn-logout" onclick="logout()">Sign Out</button>
        </div>
    </nav>

    <!-- CREATE NOTE -->
    <div class="create-container">
        <div class="create-card" id="createCard">
            <input type="text" class="inp-title" id="createTitle" placeholder="Title">
            <textarea class="inp-content" id="createContent" placeholder="Take a note..." rows="1"></textarea>
            <div class="create-actions" id="createActions">
                <button class="btn-text" onclick="closeCreate()">Close</button>
                <button class="btn-text" style="color: var(--accent)" onclick="submitNote()">Create</button>
            </div>
        </div>
    </div>

    <!-- NOTES GRID -->
    <div class="notes-grid" id="grid"></div>

    <!-- EDITOR MODAL -->
    <div class="modal" id="editorModal">
        <div class="modal-content">
            <!-- Header -->
            <div class="editor-header">
                <div style="display:flex; gap:15px; align-items:center;">
                    <button class="btn-text" onclick="closeEditor()" style="font-size:18px;">âœ•</button>
                    <div class="editor-status" id="saveStatus">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Saved
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="avatars" id="collaboratorRibbon"></div>
                    <button class="btn-share" onclick="toggleSharePopup()" style="height:32px; display:flex; align-items:center; gap:5px;">
                        <i class="fa-solid fa-user-plus"></i> Share
                    </button>
                </div>
            </div>

            <!-- Share Popup (Inside Modal) -->
            <div class="share-overlay" id="sharePopup">
                <h4 style="margin:0 0 5px 0;">Collaborate</h4>
                <p style="font-size:12px; color:#aaa; margin:0;">Enter Ignite ID to share this note.</p>
                <div class="share-inp-group">
                    <input type="text" class="share-inp" id="shareEmail" placeholder="user@ignite.com">
                    <button class="btn-share" onclick="addCollaborator()">Add</button>
                </div>
            </div>

            <!-- Body -->
            <div class="editor-body">
                <input type="text" class="editor-title" id="editTitle" placeholder="Title">
                <textarea class="editor-text" id="editContent" placeholder="Start typing..."></textarea>
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-badge" id="typingBadge">Someone is typing...</div>
        </div>
    </div>

    <script>
        // --- 1. SETUP FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
            authDomain: "xperts-metadata.firebaseapp.com",
            projectId: "xperts-metadata",
            storageBucket: "xperts-metadata.firebasestorage.app",
            messagingSenderId: "514845910910",
            appId: "1:514845910910:web:5a2402130a97b5d749b52f",
            measurementId: "G-CQ5KWGJSZB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. SESSION & UTILS ---
        let user = null;
        const myColor = '#' + Math.floor(Math.random()*16777215).toString(16);

        function init() {
            const sess = localStorage.getItem('xperts_multi_session');
            if(!sess) { window.location.href="index.html"; return; }
            user = JSON.parse(sess)[0];
            document.getElementById('displayId').innerText = user.igniteId || user.name;
            loadNotes();
        }

        function logout() {
            localStorage.removeItem('xperts_multi_session');
            window.location.href="index.html";
        }

        // --- 3. CREATE NOTE UI ---
        const cCard = document.getElementById('createCard');
        const cTitle = document.getElementById('createTitle');
        const cContent = document.getElementById('createContent');
        const cActions = document.getElementById('createActions');

        cContent.addEventListener('focus', () => {
            cCard.classList.add('active');
            cTitle.style.display = 'block';
            cActions.style.display = 'flex';
            cContent.rows = 4;
        });

        function closeCreate() {
            cCard.classList.remove('active');
            cTitle.style.display = 'none';
            cActions.style.display = 'none';
            cContent.rows = 1;
            cTitle.value = ''; cContent.value = '';
        }

        async function submitNote() {
            const title = cTitle.value;
            const content = cContent.value;
            if(!title && !content) return;

            await db.collection('notes').add({
                title, content,
                ownerId: user.uid,
                ownerEmail: user.igniteId || user.email || 'User',
                sharedWith: [], // Array of Emails
                viewers: [],    // Realtime presence
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeCreate();
        }

        // --- 4. LOAD NOTES (Query Logic) ---
        function loadNotes() {
            const grid = document.getElementById('grid');
            
            // Listener 1: Owned Notes
            db.collection('notes').where('ownerId', '==', user.uid)
              .onSnapshot(snap => processSnapshot(snap, 'owned'));

            // Listener 2: Shared Notes
            if(user.igniteId) {
                db.collection('notes').where('sharedWith', 'array-contains', user.igniteId)
                  .onSnapshot(snap => processSnapshot(snap, 'shared'));
            }
        }

        const noteCache = new Set(); // Prevent duplicates from overlapping queries

        function processSnapshot(snapshot, type) {
            snapshot.docChanges().forEach(change => {
                const doc = change.doc;
                const data = doc.data();
                const id = doc.id;

                if (change.type === 'removed') {
                    const el = document.getElementById(id);
                    if(el) el.remove();
                    return;
                }

                // Render or Update
                renderNoteCard(id, data, type);
            });
        }

        function renderNoteCard(id, data, type) {
            const grid = document.getElementById('grid');
            let el = document.getElementById(id);
            const isOwner = data.ownerId === user.uid;

            // HTML Structure
            const html = `
                <div class="note-header">
                    <span class="note-title">${data.title || ''}</span>
                    ${!isOwner ? `<i class="fa-solid fa-users" style="color:var(--accent); font-size:12px;"></i>` : ''}
                </div>
                <div class="note-body">${data.content || ''}</div>
                <div class="card-toolbar">
                    <button class="tool-btn" onclick="copyNote('${id}', '${data.title}', event)" title="Duplicate"><i class="fa-regular fa-clone"></i></button>
                    ${isOwner ? `<button class="tool-btn" onclick="openShareDirect('${id}', event)" title="Share"><i class="fa-solid fa-user-plus"></i></button>` : ''}
                    ${isOwner ? `<button class="tool-btn delete" onclick="deleteNote('${id}', event)" title="Delete"><i class="fa-solid fa-trash"></i></button>` : ''}
                </div>
            `;

            if(!el) {
                el = document.createElement('div');
                el.className = 'note-card';
                el.id = id;
                // Click to Open Editor
                el.onclick = (e) => {
                    if(!e.target.closest('button')) openEditor(id);
                };
                grid.prepend(el);
            }
            el.innerHTML = html;
        }

        // --- 5. EDITOR & REAL-TIME COLLAB ---
        let currentNoteId = null;
        let unsubscribeEditor = null;
        const eTitle = document.getElementById('editTitle');
        const eContent = document.getElementById('editContent');
        const statusEl = document.getElementById('saveStatus');
        const ribbon = document.getElementById('collaboratorRibbon');
        const typingBadge = document.getElementById('typingBadge');

        async function openEditor(id) {
            currentNoteId = id;
            document.getElementById('editorModal').style.display = 'flex';
            
            // 1. Add Presence
            const me = { name: user.name, id: user.uid, color: myColor };
            await db.collection('notes').doc(id).update({
                viewers: firebase.firestore.FieldValue.arrayUnion(me)
            });

            // 2. Listen
            unsubscribeEditor = db.collection('notes').doc(id).onSnapshot(doc => {
                if(!doc.exists) { closeEditor(); return; }
                const data = doc.data();

                // Sync Content (Lock-free, simple overwrite protection)
                if(document.activeElement !== eTitle) eTitle.value = data.title;
                if(document.activeElement !== eContent) eContent.value = data.content;

                // Sync Ribbon
                renderRibbon(data.viewers || []);

                // Sync Typing Status
                handleRemoteTyping(data.typing);
            });
        }

        function renderRibbon(viewers) {
            ribbon.innerHTML = '';
            viewers.forEach(v => {
                const d = document.createElement('div');
                d.className = 'avatar';
                d.style.backgroundColor = v.color;
                d.innerText = v.name.charAt(0);
                d.title = v.name;
                ribbon.appendChild(d);
            });
        }

        // --- 6. REAL-TIME TYPING LOGIC (Google Docs Style) ---
        let saveTimeout;
        
        // Input Handler
        const handleInput = () => {
            statusEl.innerHTML = `<span class="saving-spinner"></span> Saving...`;

            // 1. Signal Typing Instantly (Zero Latency Feel)
            db.collection('notes').doc(currentNoteId).update({
                typing: { name: user.name, id: user.uid, color: myColor, ts: Date.now() }
            });

            // 2. Debounce Save Content (500ms)
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                db.collection('notes').doc(currentNoteId).update({
                    title: eTitle.value,
                    content: eContent.value,
                    typing: null // Clear typing flag
                }).then(() => {
                    statusEl.innerHTML = `<i class="fa-solid fa-cloud"></i> Saved`;
                });
            }, 500); // 500ms delay to batch writes
        };

        eTitle.addEventListener('input', handleInput);
        eContent.addEventListener('input', handleInput);

        function handleRemoteTyping(typing) {
            if (typing && typing.id !== user.uid) {
                typingBadge.style.opacity = 1;
                typingBadge.style.backgroundColor = typing.color;
                typingBadge.innerText = `${typing.name} is typing...`;
                
                // Safety hide after 2s
                setTimeout(() => { typingBadge.style.opacity = 0; }, 2000);
            } else {
                typingBadge.style.opacity = 0;
            }
        }

        // --- 7. CLOSING & CLEANUP ---
        async function closeEditor() {
            if(!currentNoteId) return;
            
            // Remove Presence
            const ref = db.collection('notes').doc(currentNoteId);
            const doc = await ref.get();
            if(doc.exists) {
                const viewers = doc.data().viewers || [];
                const updated = viewers.filter(v => v.id !== user.uid);
                await ref.update({ viewers: updated });
            }

            document.getElementById('editorModal').style.display = 'none';
            document.getElementById('sharePopup').style.display = 'none';
            if(unsubscribeEditor) unsubscribeEditor();
            currentNoteId = null;
        }

        // --- 8. ACTIONS: SHARE, DELETE, COPY ---
        
        // COPY
        async function copyNote(id, title, e) {
            e.stopPropagation();
            const original = await db.collection('notes').doc(id).get();
            const data = original.data();
            
            await db.collection('notes').add({
                ...data,
                title: "Copy of " + (data.title || "Untitled"),
                ownerId: user.uid, // I become owner
                ownerEmail: user.igniteId,
                sharedWith: [], // Reset shares
                viewers: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Note Cloned!");
        }

        // DELETE
        async function deleteNote(id, e) {
            e.stopPropagation();
            if(confirm("Permanently delete note?")) {
                await db.collection('notes').doc(id).delete();
            }
        }

        // SHARE UI
        function toggleSharePopup() {
            const p = document.getElementById('sharePopup');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        async function addCollaborator() {
            const email = document.getElementById('shareEmail').value.trim();
            if(!email.endsWith('@ignite.com')) { alert('ID must end with @ignite.com'); return; }

            await db.collection('notes').doc(currentNoteId).update({
                sharedWith: firebase.firestore.FieldValue.arrayUnion(email)
            });
            alert(`Shared with ${email}`);
            document.getElementById('shareEmail').value = '';
            toggleSharePopup();
        }

        // Direct Share from card (Shortcut)
        async function openShareDirect(id, e) {
            e.stopPropagation();
            openEditor(id);
            setTimeout(() => toggleSharePopup(), 300); // Wait for modal animation
        }

        // Init App
        init();

        // Close on outside click logic
        window.onclick = (e) => {
            if(e.target === document.getElementById('editorModal')) closeEditor();
        }

    </script>
</body>
</html>
