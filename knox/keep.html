<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignite Workspace 2025</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* 2025 Design Tokens */
            --bg-body: #F4F7FC; /* Soft Blue-White */
            --bg-surface: #FFFFFF;
            --bg-sidebar: #FFFFFF;
            --primary: #1A73E8;
            --primary-soft: #D3E3FD;
            --text-main: #1F1F1F;
            --text-sec: #5E5E5E;
            --border: #E0E4E9;
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
            --shadow-soft: 0 8px 24px rgba(149, 157, 165, 0.1);
            --shadow-hover: 0 12px 32px rgba(149, 157, 165, 0.2);
            --transition: cubic-bezier(0.2, 0.0, 0, 1) 0.3s;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 25px;
            z-index: 10;
        }

        .brand {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
        }
        .brand span { color: var(--primary); }

        .nav-item {
            padding: 14px 20px;
            border-radius: var(--radius-md);
            color: var(--text-sec);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
            margin-bottom: 8px;
        }
        .nav-item:hover, .nav-item.active {
            background-color: var(--primary-soft);
            color: var(--primary);
        }
        
        .profile-card {
            margin-top: auto;
            background: var(--bg-body);
            padding: 15px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .avatar-small {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex; justify-content: center; align-items: center;
            font-weight: 700; font-size: 14px;
        }

        /* --- MAIN CONTENT --- */
        .main-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            position: relative;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .greeting h1 { font-size: 28px; font-weight: 600; margin: 0; }
        .greeting p { color: var(--text-sec); margin: 5px 0 0 0; }

        /* Create Button (FAB style but top) */
        .btn-create {
            background: var(--text-main);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
            display: flex; align-items: center; gap: 10px;
        }
        .btn-create:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }

        /* Notes Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid transparent;
            box-shadow: var(--shadow-soft);
            cursor: pointer;
            transition: var(--transition);
            display: flex; flex-direction: column;
            height: 180px;
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .card-title { font-weight: 700; font-size: 18px; margin-bottom: 10px; color: var(--text-main); }
        .card-body { 
            font-size: 14px; color: var(--text-sec); line-height: 1.6; 
            overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; 
        }
        
        .card-badges {
            position: absolute; top: 20px; right: 20px;
            display: flex; gap: 5px;
        }
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 20px; font-weight: 700; text-transform: uppercase; }
        .badge-shared { background: #E6F4EA; color: #137333; }

        /* --- EDITOR MODAL (Glassmorphism) --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
            z-index: 100; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }

        .editor-window {
            background: var(--bg-surface);
            width: 90%; max-width: 1100px; height: 85vh;
            border-radius: var(--radius-lg);
            display: flex;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.open .editor-window { transform: scale(1); }

        /* Editor Layout */
        .editor-main { flex: 1; display: flex; flex-direction: column; padding: 40px; position: relative; }
        .editor-sidebar { 
            width: 320px; background: #FAFAFA; border-left: 1px solid var(--border); 
            padding: 25px; display: flex; flex-direction: column; 
        }

        .editor-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .toolbar-group { display: flex; gap: 10px; align-items: center; }
        
        .tool-icon { 
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; color: var(--text-sec);
            cursor: pointer; transition: 0.2s;
        }
        .tool-icon:hover { background: var(--text-main); color: white; border-color: var(--text-main); }

        .inp-title { font-size: 32px; font-weight: 800; border: none; outline: none; margin-bottom: 20px; width: 100%; font-family: 'Outfit', sans-serif; }
        .inp-body { font-size: 18px; line-height: 1.8; color: var(--text-sec); border: none; outline: none; flex: 1; resize: none; font-family: 'Outfit', sans-serif; }

        /* Collaborators */
        .collab-stack { display: flex; flex-direction: row-reverse; }
        .collab-avatar { 
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid white; 
            margin-left: -10px; display: flex; align-items: center; justify-content: center; 
            font-size: 12px; color: white; font-weight: bold;
        }

        /* Smart Sidebar Content */
        .smart-card { background: white; border: 1px solid var(--border); border-radius: var(--radius-md); padding: 15px; margin-bottom: 15px; box-shadow: var(--shadow-soft); }
        .smart-card h4 { margin: 0 0 10px 0; font-size: 14px; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .smart-content { font-size: 13px; color: var(--text-sec); line-height: 1.5; }

        /* Typing & Status */
        .status-pill { padding: 5px 12px; background: #E6F4EA; color: #137333; border-radius: 20px; font-size: 12px; font-weight: 600; opacity: 0; transition: 0.3s; }
        .typing-bubble { 
            position: absolute; bottom: 30px; left: 40px; 
            background: var(--text-main); color: white; padding: 8px 16px; 
            border-radius: 20px; font-size: 12px; opacity: 0; transform: translateY(10px); transition: 0.3s;
        }
        .typing-bubble.active { opacity: 1; transform: translateY(0); }

        /* Modals */
        .profile-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:200; justify-content:center; align-items:center; }
        .pm-content { background:white; padding:30px; border-radius:24px; width:400px; text-align:center; }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-bolt" style="color: var(--primary);"></i> Ignite <span>Workspace</span>
        </div>
        
        <div class="nav-item active">
            <i class="fa-solid fa-layer-group"></i> My Notes
        </div>
        <div class="nav-item" onclick="alert('Shared view coming soon')">
            <i class="fa-solid fa-users"></i> Shared with me
        </div>
        <div class="nav-item" onclick="openProfile()">
            <i class="fa-solid fa-chart-pie"></i> Analytics & Profile
        </div>

        <div class="profile-card" onclick="openProfile()">
            <div class="avatar-small" id="navAvatar">U</div>
            <div style="flex:1;">
                <div style="font-size:14px; font-weight:600;" id="navName">User</div>
                <div style="font-size:11px; color:var(--text-sec);">Online</div>
            </div>
            <i class="fa-solid fa-chevron-right" style="font-size:12px; color: #ccc;"></i>
        </div>
    </div>

    <!-- MAIN AREA -->
    <div class="main-area">
        <div class="header-bar">
            <div class="greeting">
                <h1 id="welcomeTitle">Welcome back</h1>
                <p>Everything is synced and ready.</p>
            </div>
            <button class="btn-create" onclick="createNewNote()">
                <i class="fa-solid fa-plus"></i> New Note
            </button>
        </div>

        <div class="grid" id="notesGrid">
            <!-- Notes injected here -->
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div class="modal-overlay" id="editorModal">
        <div class="editor-window">
            
            <!-- Main Editor -->
            <div class="editor-main">
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <button class="tool-icon" onclick="closeEditor()"><i class="fa-solid fa-arrow-left"></i></button>
                        <div class="status-pill" id="saveStatus">Saved</div>
                    </div>
                    <div class="toolbar-group">
                        <div class="collab-stack" id="avatarStack"></div>
                        <button class="tool-icon" onclick="toggleShare()" title="Share"><i class="fa-solid fa-user-plus"></i></button>
                        <button class="tool-icon" style="color: #F28B82;" onclick="deleteCurrentNote()" title="Delete"><i class="fa-regular fa-trash-can"></i></button>
                    </div>
                </div>

                <input class="inp-title" id="eTitle" placeholder="Untitled Idea">
                <textarea class="inp-body" id="eContent" placeholder="Start typing... Highlight text for AI/Wiki tools."></textarea>
                
                <div class="typing-bubble" id="typingIndicator"> Someone is typing...</div>
            </div>

            <!-- Smart Sidebar (Right) -->
            <div class="editor-sidebar">
                <h3 style="margin-top:0; font-size:16px;">Smart Tools</h3>
                
                <!-- Translate Tool -->
                <div class="smart-card">
                    <h4><i class="fa-solid fa-language"></i> Translator</h4>
                    <select id="langSelect" style="width:100%; padding:8px; border:1px solid #eee; border-radius:8px; margin-bottom:10px;">
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                        <option value="ja">Japanese</option>
                    </select>
                    <button onclick="simulateTranslate()" style="width:100%; background:var(--text-main); color:white; border:none; padding:8px; border-radius:8px; cursor:pointer;">Translate Selection</button>
                    <div id="transResult" style="margin-top:10px; font-size:13px; font-style:italic; color:#666;"></div>
                </div>

                <!-- Wiki Tool -->
                <div class="smart-card">
                    <h4><i class="fa-brands fa-wikipedia-w"></i> Wiki Context</h4>
                    <p style="font-size:12px; color:#999; margin-bottom:10px;">Highlight text and click search.</p>
                    <button onclick="fetchWiki()" style="width:100%; background:var(--primary); color:white; border:none; padding:8px; border-radius:8px; cursor:pointer;">Search Selection</button>
                    <div id="wikiResult" class="smart-content" style="margin-top:10px;"></div>
                </div>

                <!-- Metadata -->
                <div style="margin-top:auto; font-size:12px; color:#aaa;">
                    Ignite Sync v2.5<br>Lat: 34ms
                </div>
            </div>

        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div class="profile-modal" id="profileModal">
        <div class="pm-content">
            <div style="width:80px; height:80px; background:var(--primary); border-radius:50%; margin:0 auto 20px auto; display:flex; align-items:center; justify-content:center; font-size:30px; color:white; font-weight:bold;" id="pAvatar">U</div>
            <h2 id="pName">User Name</h2>
            <p id="pEmail" style="color:gray;">user@ignite.com</p>
            
            <div style="display:flex; justify-content:space-around; margin:25px 0; background:#f9f9f9; padding:15px; border-radius:12px;">
                <div>
                    <div style="font-weight:bold; font-size:20px;" id="statNotes">0</div>
                    <div style="font-size:12px; color:gray;">Notes</div>
                </div>
                <div>
                    <div style="font-weight:bold; font-size:20px;">Pro</div>
                    <div style="font-size:12px; color:gray;">Plan</div>
                </div>
            </div>

            <button onclick="logout()" style="background:#FFE5E5; color:#D32F2F; border:none; padding:10px 30px; border-radius:50px; font-weight:bold; cursor:pointer; width:100%;">Sign Out</button>
            <button onclick="document.getElementById('profileModal').style.display='none'" style="background:transparent; color:gray; border:none; margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyDL7sPp-FkG59L-mRQ7BrCGgeKMhQC80iw",
            authDomain: "xperts-metadata.firebaseapp.com",
            projectId: "xperts-metadata",
            storageBucket: "xperts-metadata.firebasestorage.app",
            messagingSenderId: "514845910910",
            appId: "1:514845910910:web:5a2402130a97b5d749b52f",
            measurementId: "G-CQ5KWGJSZB"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- 2. SESSION & STATE ---
        let user = null;
        let myColor = '#' + Math.floor(Math.random()*16777215).toString(16);

        function init() {
            const sess = localStorage.getItem('xperts_multi_session');
            if(!sess) { window.location.href="index.html"; return; }
            user = JSON.parse(sess)[0];
            
            // Update Profile UI
            document.getElementById('navName').innerText = user.name;
            document.getElementById('navAvatar').innerText = user.name.charAt(0);
            document.getElementById('pName').innerText = user.name;
            document.getElementById('pEmail').innerText = user.igniteId || user.email;
            document.getElementById('pAvatar').innerText = user.name.charAt(0);
            document.getElementById('welcomeTitle').innerText = `Welcome back, ${user.name.split(' ')[0]}`;
            
            loadNotes();
        }

        function logout() {
            localStorage.removeItem('xperts_multi_session');
            window.location.href="index.html";
        }

        function openProfile() { document.getElementById('profileModal').style.display = 'flex'; }

        // --- 3. NOTES LOGIC (New Note) ---
        async function createNewNote() {
            const docRef = await db.collection('notes').add({
                title: "",
                content: "",
                ownerId: user.uid,
                sharedWith: [],
                viewers: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            openEditor(docRef.id);
        }

        // --- 4. DISPLAY NOTES (Realtime Grid) ---
        function loadNotes() {
            // Own Notes
            db.collection('notes').where('ownerId', '==', user.uid)
              .onSnapshot(snap => renderNotes(snap, true));
            
            // Shared Notes
            if(user.igniteId) {
                db.collection('notes').where('sharedWith', 'array-contains', user.igniteId)
                  .onSnapshot(snap => renderNotes(snap, false));
            }
        }

        function renderNotes(snapshot, isOwner) {
            snapshot.docChanges().forEach(change => {
                const doc = change.doc;
                const data = doc.data();
                const id = doc.id;

                if (change.type === 'removed') {
                    const el = document.getElementById(id);
                    if(el) el.remove();
                    updateStats();
                    return;
                }

                let el = document.getElementById(id);
                const html = `
                    ${!isOwner ? '<div class="card-badges"><span class="badge badge-shared">Shared</span></div>' : ''}
                    <div class="card-title">${data.title || 'Untitled Note'}</div>
                    <div class="card-body">${data.content || 'No content...'}</div>
                `;

                if(!el) {
                    el = document.createElement('div');
                    el.className = 'card';
                    el.id = id;
                    el.onclick = () => openEditor(id);
                    document.getElementById('notesGrid').prepend(el);
                }
                el.innerHTML = html;
            });
            updateStats();
        }

        function updateStats() {
            const count = document.getElementById('notesGrid').children.length;
            document.getElementById('statNotes').innerText = count;
        }

        // --- 5. ULTRA-MODERN EDITOR (With Smart Tools) ---
        let currentNoteId = null;
        let editorUnsub = null;
        const eTitle = document.ge
